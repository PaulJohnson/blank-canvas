<html>
    <head>
         <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAD50lEQVRYR+1WO0gjURS9UymCuAvxUwhmC9FSUcFvo4ilImihQhJtFASzlXZqpabZiIU2ml1QEQVJBPFf+cFCk8VKVNgERFAUNtWaavadq2+c0VFn4wa32AuTzOfd+849775zn0JvMvWXcL8lUj7GG0ZRbbYgXV8XxhvgTX42W0hRiVRSxe97mKLQEwCxWIyCwSBtb28zpPr6esrKyqLh4WFyOp2Ul5dnCWokEiG73U7Hx8fP+5gBmJiYoK6uLsMkOzs7VFlZySB6e3stAdjc3KTa2lra2Nig3Nxc9snJyTH6mgHY29ujiooK6ujooPT0dJ50enqa2traNADRaJTm5uaos7OTRkZGmKWenh7Kzs6myclJCgQClJKSwgD6+vrYr66ujlZXV18HIKnTj9Qz4Ha7ecK1tTVtCLLEZHpbWFigpqYm7ZXf72c/g5kxIAHIgAju9XoJEyOTqqoqZghLgexhEgCYOj8/56wla/iO7MFKUlKSdQBYgurqamptbdUmA4CioiLOdmZmhr/BZLYAcnh4+AQAxgDUwMCAEcRLDOihbm1tUU1NDddFd3c3FRYaZQNMgBEzAKB+aWmJpqamaHd3l8rLyx9CmwHAV2QHKpEtKhjb0OfzUWpqKmeNCkemaWlpHKykpIS3G5i5uLig/f19amxspMXFRf7XL1NGRsbrAIwLlcCn5xhI4JTWivDs7Iz3cVlZWWKx6BmABI+OjhqULhQKUUFBwV8DcXV1xbtA1g7pAaDwoHYoJIfDwfeoWhgqGEUJgKjq09NTVjzsivb2dtYFFCEsPz+f729ubgx+BwcHHBOmiZIEELu9peTkZP54eXlJslKlnksKzBSvv7+fBgcHGUxxcTH3EfQTyLS0+fl5am5u1p7Hx8fvvksAkXCYOxfEYmhoiLAcAILsoAFS9fQAsDzQA4jTyckJZysNmqH3W15eZjWFPwxst7S0PADAeUARaGCgD3tcqpx0wDOQy04ZvgctG40UJ/0YqZYej4cB6fuHijOIvgag1Q0NDVoWqAV0w9nZWdMi1ANAn5BLCGbGxsYMjDwOgNjr6+tGABiEVoyDCKpUKhjUDO0XrRaWmZnJ/2hKUMfS0lLeKfA9OjritUW1P/bDeWJlZYVjuVyuuzr7J4XIlO9EvWQG3vtUbJJcoo/Id9vt3gwP9+/+A3i0KmpYvMB5WhyDlO/W6lFFBwuJS/gqn17yMVsC3XjVLh5+iCsqAn2wNrkcpf4UdzgyCQAKkjC11wA4hZdPXAER5EEmLSFR/WIYzuEu4fs1XgBwdIjrswjitTSvNkh1i9sv4vomfJFIXAyAuj9cf20JLNXBbyIMLf/FngRdAAAAAElFTkSuQmCC"/>
         <title>Blank Canvas</title>
        <script type="text/javascript" src="jquery.js"></script>
        <script type="text/javascript" src="jquery-json.js"></script>
        <script type="text/javascript" src="kansas-comet.js"></script>
    </head>
    <body style="padding: 0px; margin: 0px; border:0px">
        <div id="canvas"></div>
        <script type="text/javascript">
            var session = 0; // global session number
            var images = [];
            var gradients = [];
            var patterns = [];
            var canvasbuffers = [];
            var c = null;
            var myDevicePixelRatio = 1; // "my" because this would nameclass with the window.* version

            var urlQuery = {};
            // From http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
            location.search.substr(1).split("&").forEach(function(item) {
                    urlQuery[item.split("=")[0]] = item.split("=")[1];
            });

            function reply(e) {
                return function(u) { return $.kc.reply(u,e); }
            }
            function getContext() {
                var canvas = document.getElementById("canvas");
                if (canvas.getContext) {
                    return canvas.getContext("2d");
                }
                alert("no canvas");
            }
            // These are the Queries

            function Device(u,c) {
                $.kc.reply(u,[c.canvas.width, c.canvas.height,myDevicePixelRatio]);
            }
            function Size(u,c) {
                $.kc.reply(u,[c.canvas.width, c.canvas.height]);
            }
            function ToDataURL(u,c) {
                $.kc.reply(u,c.canvas.toDataURL());
                            
            }
            function NewImage(src) { 
                return function (u,c) {
                    var img = new Image();
                    var count = images.push(img);
                    img.onload = function() {
                           $.kc.reply(u,count - 1);
                    };
                    img.onerror = function() { alert("Image " + src + " not found.\nAdd as a static file to fix this."); };
                    img.src = src;
                }        
            }

            function CreateLinearGradient(x0,y0,x1,y1) { 
                return function (u,c) {
                    var count = gradients.push(c.createLinearGradient(x0,y0,x1,y1));
                    $.kc.reply(u,count - 1);
                }        
            }

            function CreateRadialGradient(x0,y0,r0,x1,y1,r1) { 
                return function (u,c) {
                    var count = gradients.push(c.createRadialGradient(x0,y0,r0,x1,y1,r1));
                    $.kc.reply(u,count - 1);
                }        
            }

            function CreatePattern(img,src) { 
                return function (u,c) {
                    var count = patterns.push(c.createPattern(img,src));
                    $.kc.reply(u,count - 1);
                }        
            }

            function MeasureText(txt) { 
                return function (u,c) {
                    $.kc.reply(u,c.measureText(txt));
                }        
            }
            function IsPointInPath(x,y) { 
                return function (u,c) {
                    $.kc.reply(u,c.isPointInPath(x,y));
                }        
            }

            function NewCanvas(w,h) { 
                return function (u,c) {
                    var canvas = document.createElement('canvas');
                    canvas.width = w;
                    canvas.height = h;
                    var count = canvasbuffers.push(canvas.getContext("2d"));
                    $.kc.reply(u,count - 1);
                }        
            }

            function GetImageData(sx,sy,sw,sh) { 
                return function (u,c) {
                    var img = c.getImageData(sx,sy,sw,sh);
                    var arr = []; // empty for now
                    for(var i = 0;i < img.data.length;i++) {
                            arr[i] = img.data[i];
                    }
                    $.kc.reply(u,{ width: img.width
                                 , height: img.height
                                 , data: arr
                                 });
                }        
            }

            function Trigger(e) { 
                $.kc.event({ eMetaKey: e.eMetaKey,
                             ePageXY : e.ePageXY,
                             eType   : e.eType,
                             eWhich  : e.eWhich
                            });
            }
            /* -------------------- */
            function newContext(width, height) {
                var buffer = document.createElement('canvas');
                buffer.width = width;
                buffer.height = height;
                return buffer.getContext('2d');
            }
            function register(name) {
                $(document).bind(name,function (e){
                        $.kc.event({ eMetaKey: e.metaKey,
                                     ePageXY : [e.pageX,e.pageY],
                                     eType   : e.type,
                                     eWhich  : e.which
                                    });
                });
            }  
            function redraw() {
                $.ajax({ url: "/canvas/" + session,
                         type: "GET",
                         dataType: "script",
                         success: function success() {
                                 redraw();
                         }
                         }); 
             }
             
            $(document).ready(function() {
                // Make the canvas the size of the window
                var w = $(window).width();
                var h = $(window).height();
                var b = "0";
                if (urlQuery.border && !isNaN(parseInt(urlQuery.border))) {
                  b = parseInt(urlQuery.border);
                  w -= b * 2;
                  h -= b * 2;
                }
                if (urlQuery.width) {
                  w = urlQuery.width;
                }
                if (urlQuery.height) {
                  h = urlQuery.height;
                }
                if ('hd' in urlQuery && 'devicePixelRatio' in window) {
                  myDevicePixelRatio = window.devicePixelRatio;
                }
                $("#canvas").replaceWith(
                            '<canvas id="canvas" width="' + (w * myDevicePixelRatio) + '" height="' + (h * myDevicePixelRatio) +
                            '" style="border: black solid ' + b + 'px; padding: 0px; margin: 0px"></canvas>');
                $("#canvas").css("width",w + "px");            
                $("#canvas").css("height",h + "px");            
                c = getContext("2d");
                canvasbuffers.push(c);
                $.kc.connect("/blank");
            });
        </script>
    </body>
</html>
